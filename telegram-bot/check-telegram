#!/bin/bash

# check-telegram - Check for pending Telegram instructions
# Usage: ./check-telegram or just run the command

ALERT_FILE="/srv/apps/openclaw-ai-gateway/collab/.telegram-alert"
INSTRUCTIONS_FILE="/srv/apps/openclaw-ai-gateway/collab/INSTRUCTIONS.md"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘          ğŸ“± TELEGRAM INSTRUCTION CHECKER                     â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

if [ -f "$ALERT_FILE" ]; then
    echo -e "${GREEN}ğŸš¨ NEW TELEGRAM MESSAGE DETECTED!${NC}"
    echo ""
    
    # Parse the JSON alert
    USERNAME=$(cat "$ALERT_FILE" | grep -o '"username": "[^"]*"' | cut -d'"' -f4)
    MESSAGE=$(cat "$ALERT_FILE" | grep -o '"message": "[^"]*"' | cut -d'"' -f4)
    TIMESTAMP=$(cat "$ALERT_FILE" | grep -o '"timestamp": "[^"]*"' | cut -d'"' -f4)
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ‘¤ From: @$USERNAME"
    echo "ğŸ• Time: $TIMESTAMP"
    echo "ğŸ’¬ Message: $MESSAGE"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo -e "${YELLOW}ğŸ‘‰ Treat this as a direct request from the user${NC}"
    echo ""
    echo "Quick actions:"
    echo "  â€¢ Respond to the request now"
    echo "  â€¢ Update STATUS.md when done"
    echo "  â€¢ Run: telegram-done (to mark as complete)"
    echo ""
    
    # Also show the full instruction file
    if [ -f "$INSTRUCTIONS_FILE" ]; then
        echo "ğŸ“„ Full instruction details:"
        echo "---"
        cat "$INSTRUCTIONS_FILE"
        echo "---"
    fi
    
    exit 0
else
    echo -e "${BLUE}â„¹ï¸  No pending Telegram messages${NC}"
    echo ""
    echo "Last check: $(date)"
    echo ""
    echo "To check manually: cat /srv/apps/openclaw-ai-gateway/collab/.telegram-alert"
    echo "To see all instructions: cat /srv/apps/openclaw-ai-gateway/collab/INSTRUCTIONS.md"
    echo ""
    exit 1
fi
